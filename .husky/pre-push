#!/bin/sh
set -o pipefail

# Get list of files changed in commits being pushed (compared to remote)
# If remote doesn't exist yet, compare to HEAD~1
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$REMOTE_BRANCH" ]; then
  CHANGED_FILES=$(git diff --name-only "$REMOTE_BRANCH"...HEAD)
else
  # No remote tracking branch, check commits that would be pushed
  CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD 2>/dev/null || git diff --name-only --cached)
fi

# Categorize changes
HAS_SRC_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.(ts|js)$' || true)
HAS_TEST_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.(test|spec)\.(ts|js)$' || true)
HAS_CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^(package\.json|tsconfig\.json|vitest\.config\.ts)' || true)

# Skip coverage if no source or test files changed
if [ -z "$HAS_SRC_CHANGES" ] && [ -z "$HAS_TEST_CHANGES" ]; then
  echo "‚ÑπÔ∏è  No source/test changes detected, skipping coverage tests"
  exit 0
fi

# Run coverage tests - capture exit code before filtering output
echo "üß™ Running coverage tests..."
COVERAGE_OUTPUT=$(bun run test:coverage 2>&1)
COVERAGE_EXIT=$?

# Show filtered summary
echo "$COVERAGE_OUTPUT" | grep -E '(FAIL|Test Files|passed|Coverage|threshold|ERROR)' | tail -15

if [ $COVERAGE_EXIT -ne 0 ]; then
  echo "‚ùå Coverage tests failed"
  exit 1
fi

echo "‚úÖ Coverage tests passed"
