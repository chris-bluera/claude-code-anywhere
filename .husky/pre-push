#!/bin/sh
set -o pipefail

# Get list of files changed in commits being pushed (compared to remote)
# If remote doesn't exist yet, compare to HEAD~1
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$REMOTE_BRANCH" ]; then
  CHANGED_FILES=$(git diff --name-only "$REMOTE_BRANCH"...HEAD)
else
  # No remote tracking branch, check commits that would be pushed
  CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD 2>/dev/null || git diff --name-only --cached)
fi

# Categorize changes
HAS_SRC_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^src/.*\.(ts|js)$' || true)
HAS_TEST_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.(test|spec)\.(ts|js)$' || true)
HAS_CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^(package\.json|tsconfig\.json|vitest\.config\.ts)' || true)

# Skip coverage if no source or test files changed
if [ -z "$HAS_SRC_CHANGES" ] && [ -z "$HAS_TEST_CHANGES" ]; then
  echo "‚ÑπÔ∏è  No source/test changes detected, skipping coverage tests"
  exit 0
fi

# Run ALL tests with coverage to catch regressions
echo "üß™ Running tests with coverage..."
bun run test:coverage:quiet || { echo "‚ùå Coverage below threshold - push blocked"; exit 1; }
echo "‚úÖ All tests passed with coverage"
