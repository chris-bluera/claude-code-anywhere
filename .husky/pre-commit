#!/bin/sh

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Categorize changes
HAS_SRC_CHANGES=$(echo "$STAGED_FILES" | grep -E '^src/.*\.(ts|js)$' || true)
HAS_TEST_CHANGES=$(echo "$STAGED_FILES" | grep -E '\.(test|spec)\.(ts|js)$' || true)
HAS_CONFIG_CHANGES=$(echo "$STAGED_FILES" | grep -E '^(package\.json|tsconfig\.json|vitest\.config\.ts|\.eslintrc|knip\.json)' || true)
HAS_DOC_CHANGES=$(echo "$STAGED_FILES" | grep -E '\.(md|txt)$|^LICENSE|^NOTICE' || true)
HAS_DIST_CHANGES=$(echo "$STAGED_FILES" | grep -E '^dist/' || true)

# If only documentation changed (and no code/config), skip all checks
if [ -n "$HAS_DOC_CHANGES" ] && [ -z "$HAS_SRC_CHANGES" ] && [ -z "$HAS_TEST_CHANGES" ] && [ -z "$HAS_CONFIG_CHANGES" ]; then
  echo "‚ÑπÔ∏è  Only documentation changed, skipping code validation"
  exit 0
fi

# If only dist/ changed (shouldn't happen, but handle it), skip checks
if [ -n "$HAS_DIST_CHANGES" ] && [ -z "$HAS_SRC_CHANGES" ] && [ -z "$HAS_TEST_CHANGES" ] && [ -z "$HAS_CONFIG_CHANGES" ]; then
  echo "‚ÑπÔ∏è  Only dist/ changed, skipping validation"
  exit 0
fi

# Run checks based on what changed
echo "üîç Running validation checks..."

# Always run lint and typecheck for code/config changes
if [ -n "$HAS_SRC_CHANGES" ] || [ -n "$HAS_TEST_CHANGES" ] || [ -n "$HAS_CONFIG_CHANGES" ]; then
  bun run lint:quiet || exit 1
  bun run lint:deadcode:quiet || exit 1
  bun run typecheck:quiet || exit 1
fi

# Run tests only if source or test files changed
if [ -n "$HAS_SRC_CHANGES" ] || [ -n "$HAS_TEST_CHANGES" ]; then
  bun run test:changed:quiet || exit 1
fi

# Build only if source or config changed
if [ -n "$HAS_SRC_CHANGES" ] || [ -n "$HAS_CONFIG_CHANGES" ]; then
  bun run build:quiet || exit 1
  # Auto-stage dist/ after build (required for Claude Code plugin distribution)
  git add dist/
fi

echo "‚úÖ All checks passed"
